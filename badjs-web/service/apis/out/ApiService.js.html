<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: ApiService.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: ApiService.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';
const Promise = require('bluebird');

const userService = require('../UserService.js'),
    crypto = require('crypto'),
    logger = require('log4js').getLogger(),
    ApplyService = require('../ApplyService.js');
function _getUserByName(name) {

    const db = global.models.db;

    return new Promise((resolve, reject) => {

        if (!/^\w+$/.test(name)) {
            reject('name error.');
            return;
        }

        let sql = `select id, loginName, chineseName, role, email from b_user where loginName='${name}'`,
            userObj;

        db.driver.execQuery(sql, (err, data) => {

            if (err) {
                logger.error(err);
                reject(err)
            } else {
                if (data.length > 0) {
                    userObj = data[0];
                    resolve({
                        userId: userObj.id,
                        name: userObj.loginName,
                        role: userObj.role,
                        email: userObj.email
                    });
                } else {
                    reject({retcode: 1, msg: 'user not found'});

                }
            }
        })
    })
}



/**
 * 获取用户资料
 * @param {string} name 用户名
 *
 * @returns {Promise} userObj 用户对象 
 */
function getUser(name) {

    return _getUserByName(name);

}

function _addApply(apply) {

    return new Promise((resolve, reject) => {

        new ApplyService().add(apply, (err, item) => {

            if (err) {

                reject({retcode: 1, msg: err});
            }else {
                resolve({retcode: 0, badjsId: item.applyId});
            }

        })
    })
}


/**
 * 自动注册项目 
 * @param {object} applyObj  { applyObj.applyName 项目名称 ,  applyObj.url 项目url }
 *
 * @returns {promise} obj { obj.retcode 返回码 ,  obj.badjsId badjs id }
 *
 */
function registApply(applyObj) {

    if (!applyObj.applyName || !applyObj.url) {
        return Promise.reject({retcode: 2, msg: 'params error. '});
    }

    var apply = {
        userName : applyObj.userName,
        status : 0,
        name : applyObj.applyName,
        appkey : crypto.createHash("md5").update(new Date - 0 + "badjsappkey" + applyObj.userName).digest('hex'),
        url: applyObj.url,
        blacklist: applyObj.blacklist || '{"ip":[],"ua":[]}',
        description: applyObj.description,
        mail: '',
        createTime : new Date(),
        passTime: new Date(),
    }

    return getUser(apply.userName).then(data => {
        apply.user = {id: data.userId};
        return _addApply(apply);
    }).catch(e => {
        return e;
    })



}

module.exports = {
    getUser,
    registApply
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#getUser">getUser</a></li><li><a href="global.html#registApply">registApply</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.4</a> on Mon Sep 18 2017 10:49:36 GMT+0800 (中国标准时间)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
